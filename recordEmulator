#!/bin/bash

HELP="Usage: $(basename $0) [FILE_NAME].[FILE_EXT] [ -p SAVE_DIR ] [ -d SIM_NAME ]

    [FILE_NAME], filename
    [FILE_EXT], file extension: can be either MP4 or MOV
    [SAVE_DIR], path to save generated file, current dir if empty
    [SIM_NAME], simulator name or UUID

    List of available devices and UUIDs:
$(xcrun simctl list devices | sed -ne 's/^[ \t]*\(.*\) (Booted)/    * \1/p')
"

if [ -z "$1" ]; then
    echo "$HELP"
    exit 1
fi

SAVE_DIR="$PWD"
DEVICE_NAME="booted"
FILE_NAME="${1/.*/}"
FILE_EXT=$(echo ${1##*.} | tr '[:upper:]' '[:lower:]')

if [[ ! $FILE_EXT =~ ^(mov|mp4)$ ]]; then
    echo "Invalid file extension \".$FILE_EXT\""
    echo "$HELP"
    exit 1
fi

function testFilePath {
    if [ -f "$1/$2" ]; then
        if [[ "$2" =~ [[:blank:]]\([0-9]+\) ]]; then
            CURR_COUNT=$(sed -r "s/.* \(([0-9]+)\).*/\1/" <<< "$2")
            ((CURR_COUNT+=1))
            testFilePath "$1" "${2/ ([0-9]*)/ ($CURR_COUNT)}"
        else
            testFilePath "$1" "$FILE_NAME (1).$FILE_EXT"
        fi
    else 
        NEW_FILE="$2"
    fi
}

while getopts "p:d:" opt "${@:2}"; do
    case "$opt" in
        p)
            SAVE_DIR="$OPTARG";;
        d)
            DEVICE_NAME="$OPTARG";;
        *)
            echo "$HELP"
            exit 1;;
    esac
done

NEW_FILE="$FILE_NAME.$FILE_EXT"

testFilePath "$SAVE_DIR" "$NEW_FILE"
echo "File will be saved under $SAVE_DIR/$NEW_FILE"

mkdir -p "$SAVE_DIR" && cd "$SAVE_DIR"

echo "Wait for recording to start... press CTRL+C to stop"

xcrun simctl io "$DEVICE_NAME" recordVideo "$NEW_FILE"
